package com.metradingplat.marketdata.infrastructure.input.controllerGestionarHistoricalData.controller;

import java.time.OffsetDateTime;
import java.util.List;

import java.util.HashMap;
import java.util.Map;

import org.springframework.format.annotation.DateTimeFormat;
import org.springframework.http.ResponseEntity;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import com.metradingplat.marketdata.application.input.GestionarHistoricalDataCUIntPort;
import com.metradingplat.marketdata.domain.enums.EnumTimeframe;
import com.metradingplat.marketdata.domain.models.Candle;
import com.metradingplat.marketdata.infrastructure.input.controllerGestionarHistoricalData.DTOAnswer.BatchCandlesDTORespuesta;
import com.metradingplat.marketdata.infrastructure.input.controllerGestionarHistoricalData.DTOAnswer.CandleDTORespuesta;
import com.metradingplat.marketdata.infrastructure.input.controllerGestionarHistoricalData.DTOPetition.BatchCandlesDTOPeticion;
import com.metradingplat.marketdata.infrastructure.input.controllerGestionarHistoricalData.mapper.HistoricalDataMapper;

import jakarta.validation.Valid;
import jakarta.validation.constraints.NotNull;
import lombok.RequiredArgsConstructor;

@RestController
@RequestMapping("/api/marketdata/historical")
@RequiredArgsConstructor
@Validated
public class HistoricalDataRestController {

    private final GestionarHistoricalDataCUIntPort objGestionarHistoricalDataCUInt;
    private final HistoricalDataMapper objMapper;

    @GetMapping("/{symbol}")
    public ResponseEntity<List<CandleDTORespuesta>> getCandles(
            @PathVariable("symbol") @NotNull String symbol,
            @RequestParam("timeframe") @NotNull EnumTimeframe timeframe,
            @RequestParam(value = "endDate", required = false)
                @DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME) OffsetDateTime endDate,
            @RequestParam(value = "bars", required = false) Integer bars) {

        List<Candle> candles = this.objGestionarHistoricalDataCUInt.getCandles(symbol, timeframe, endDate, bars);
        return ResponseEntity.ok(this.objMapper.deDominioARespuestas(candles));
    }

    @GetMapping("/{symbol}/current")
    public ResponseEntity<CandleDTORespuesta> getCurrentCandle(
            @PathVariable("symbol") @NotNull String symbol,
            @RequestParam("timeframe") @NotNull EnumTimeframe timeframe) {

        Candle candle = this.objGestionarHistoricalDataCUInt.getCurrentCandle(symbol, timeframe);

        if (candle == null) {
            return ResponseEntity.noContent().build();
        }

        return ResponseEntity.ok(this.objMapper.deDominioARespuesta(candle));
    }

    @GetMapping("/{symbol}/last")
    public ResponseEntity<CandleDTORespuesta> getLastCandle(
            @PathVariable("symbol") @NotNull String symbol,
            @RequestParam("timeframe") @NotNull EnumTimeframe timeframe) {

        Candle candle = this.objGestionarHistoricalDataCUInt.getLastCandle(symbol, timeframe);

        if (candle == null) {
            return ResponseEntity.noContent().build();
        }

        return ResponseEntity.ok(this.objMapper.deDominioARespuesta(candle));
    }
}
